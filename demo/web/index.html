<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Think First AI - Demo</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --header-height: 60px;
      --sidebar-width: 400px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      margin: 0;
      padding: 0;
    }

    .header {
      background: white;
      padding: 15px 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      z-index: 10;
      height: var(--header-height);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }

    h1 {
      color: #667eea;
      font-size: 1.5em;
      margin: 0;
    }

    .header-controls {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #666;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #f44336;
      transition: background 0.3s;
    }

    .status-dot.connected {
      background: #4caf50;
    }

    .status-dot.disconnected {
      background: #f44336;
    }

    button {
      padding: 8px 16px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: background 0.3s;
    }

    button:hover {
      background: #5568d3;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    button.active {
      background: #4caf50;
    }

    button.active:hover {
      background: #45a049;
    }

    .play-pause-btn {
      min-width: 80px;
    }

    .play-pause-btn.paused {
      background: #9e9e9e;
    }

    .play-pause-btn.paused:hover {
      background: #757575;
    }

    .main-content {
      flex: 1;
      display: flex;
      overflow: hidden;
      position: relative;
      min-height: 0;
    }

    .chat-container {
      flex: 1;
      max-width: 1200px;
      max-height: 100%;
      width: 100%;
      margin: 0 auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: margin-right 0.3s ease;
      min-height: 0;
    }

    .chat-container.sidebar-open {
      margin-right: 400px;
    }

    .chat-messages {
      flex: 1;
      background: white;
      border-radius: 10px;
      padding: 20px;
      overflow-y: auto;
      overflow-x: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      gap: 15px;
      min-height: 0;
      max-height: 100%;
    }

    .message {
      display: flex;
      max-width: 70%;
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.user {
      align-self: flex-end;
      justify-content: flex-end;
    }

    .message.ai {
      align-self: flex-start;
      justify-content: flex-start;
    }

    .message-bubble {
      padding: 12px 16px;
      border-radius: 18px;
      word-wrap: break-word;
      white-space: pre-wrap;
      line-height: 1.4;
    }

    .message.user .message-bubble {
      background: #667eea;
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message.ai .message-bubble {
      background: #f0f0f0;
      color: #333;
      border-bottom-left-radius: 4px;
    }

    .message-time {
      font-size: 11px;
      color: #999;
      margin-top: 4px;
      padding: 0 4px;
    }

    .message.user .message-time {
      text-align: right;
    }

    .message.ai .message-time {
      text-align: left;
    }

    .thinking-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background: #fff3cd;
      border-radius: 18px;
      border-bottom-left-radius: 4px;
      color: #856404;
      font-size: 14px;
      max-width: 70%;
      align-self: flex-start;
    }

    .thinking-dots {
      display: inline-flex;
      gap: 4px;
    }

    .thinking-dots span {
      width: 6px;
      height: 6px;
      background: #856404;
      border-radius: 50%;
      animation: thinking 1.4s infinite;
    }

    .thinking-dots span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .thinking-dots span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes thinking {

      0%,
      60%,
      100% {
        opacity: 0.3;
        transform: scale(0.8);
      }

      30% {
        opacity: 1;
        transform: scale(1);
      }
    }

    .chat-footer {
      background: white;
      padding: 15px 20px;
      border-radius: 10px;
      margin-top: 15px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      display: flex;
      gap: 10px;
      flex-shrink: 0;
      position: relative;
    }

    .chat-input {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 25px;
      font-size: 16px;
      font-family: inherit;
      outline: none;
      transition: border-color 0.3s;
    }

    .chat-input:focus {
      border-color: #667eea;
    }

    .send-button {
      padding: 12px 24px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: background 0.3s;
      min-width: 80px;
    }

    .send-button:hover {
      background: #5568d3;
    }

    .send-button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .tools-settings {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .gear-icon {
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 20px;
      padding: 8px;
      color: #667eea;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background 0.3s;
      width: 36px;
      height: 36px;
    }

    .gear-icon:hover {
      background: #f0f0f0;
    }

    .tools-dropdown {
      position: absolute;
      bottom: 100%;
      left: 0;
      margin-bottom: 10px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      min-width: 220px;
      padding: 12px;
      display: none;
      z-index: 1000;
      border: 1px solid #e0e0e0;
    }

    .tools-dropdown.open {
      display: block;
    }

    .tools-dropdown-header {
      font-weight: 600;
      font-size: 14px;
      color: #333;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e0e0e0;
    }

    .tool-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
      cursor: pointer;
    }

    .tool-item:hover {
      background: #f5f5f5;
      margin: 0 -12px;
      padding-left: 12px;
      padding-right: 12px;
    }

    .tool-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: #667eea;
    }

    .tool-item label {
      cursor: pointer;
      font-size: 14px;
      color: #333;
      flex: 1;
      user-select: none;
    }

    .tool-description {
      font-size: 12px;
      color: #666;
      margin-top: 2px;
    }

    .error-message {
      background: #ffebee;
      color: #c62828;
      padding: 12px 16px;
      border-radius: 18px;
      border-bottom-left-radius: 4px;
      max-width: 70%;
      align-self: flex-start;
    }

    .sidebar {
      position: fixed;
      right: calc(var(--sidebar-width) * -1);
      top: var(--header-height);
      width: var(--sidebar-width);
      height: calc(100vh - var(--header-height));
      background: white;
      box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
      transition: right 0.3s ease;
      z-index: 100;
      display: flex;
      flex-direction: column;
    }

    .sidebar.open {
      right: 0;
    }

    .sidebar-header {
      padding: 15px 20px;
      border-bottom: 2px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f5f5f5;
    }

    .sidebar-header h2 {
      color: #333;
      font-size: 1.2em;
      margin: 0;
    }

    .sidebar-close {
      background: transparent;
      color: #666;
      padding: 4px 8px;
      font-size: 20px;
      border: none;
      cursor: pointer;
      line-height: 1;
    }

    .sidebar-close:hover {
      color: #333;
      background: #e0e0e0;
    }

    .debug-log {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.6;
      background: #1e1e1e;
      color: #d4d4d4;
    }

    .debug-entry {
      margin-bottom: 12px;
      padding: 8px 12px;
      border-radius: 4px;
      border-left: 3px solid;
      background: rgba(255, 255, 255, 0.05);
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    .debug-entry.user-message {
      border-left-color: #667eea;
      background: rgba(102, 126, 234, 0.1);
    }

    .debug-entry.ai-thinking {
      border-left-color: #ffc107;
      background: rgba(255, 193, 7, 0.1);
    }

    .debug-entry.tool-call {
      border-left-color: #4caf50;
      background: rgba(76, 175, 80, 0.1);
    }

    .debug-entry.ai-message {
      border-left-color: #2196f3;
      background: rgba(33, 150, 243, 0.1);
    }

    .debug-entry.error {
      border-left-color: #f44336;
      background: rgba(244, 67, 54, 0.1);
    }

    .debug-entry.system {
      border-left-color: #9e9e9e;
      background: rgba(158, 158, 158, 0.1);
    }

    .debug-entry-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      opacity: 0.8;
    }

    .debug-entry-time {
      font-size: 10px;
      opacity: 0.6;
    }

    .debug-entry-content {
      margin-top: 4px;
    }

    .debug-toggle-btn {
      background: #9e9e9e;
    }

    .debug-toggle-btn:hover {
      background: #757575;
    }

    @media (max-width: 768px) {
      .message {
        max-width: 85%;
      }

      .header-content {
        flex-direction: column;
        align-items: flex-start;
      }

      .sidebar {
        width: 100%;
        right: -100%;
      }

      .sidebar.open {
        right: 0;
      }

      .chat-container.sidebar-open {
        margin-right: 0;
      }
    }
  </style>
</head>

<body>
  <div class="header">
    <div class="header-content">
      <h1>üß† Think First AI</h1>
      <div class="header-controls">
        <div class="status-indicator">
          <span class="status-dot disconnected" id="statusDot"></span>
          <span id="statusText">Disconnected</span>
        </div>
        <button id="playPauseBtn" class="play-pause-btn" onclick="togglePlayPause()">‚ñ∂ Play</button>
        <button id="debugToggleBtn" class="debug-toggle-btn" onclick="toggleDebugSidebar()">Debug</button>
      </div>
    </div>
  </div>

  <div class="sidebar" id="debugSidebar">
    <div class="debug-log" id="debugLog"></div>
  </div>

  <div class="main-content">
    <div class="chat-container" id="chatContainer">
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-footer">
        <div class="tools-settings">
          <button class="gear-icon" onclick="toggleToolsDropdown()" title="Tool Settings">‚öôÔ∏è</button>
          <div class="tools-dropdown" id="toolsDropdown">
            <div class="tools-dropdown-header">Enable/Disable Tools</div>
            <div class="tool-item">
              <input type="checkbox" id="tool-send-message" checked
                onchange="updateToolSetting('send_message_to_user', this.checked)">
              <label for="tool-send-message">
                Send Message to User
                <div class="tool-description">Allow AI to send messages to the user</div>
              </label>
            </div>
            <div class="tool-item">
              <input type="checkbox" id="tool-wait" checked onchange="updateToolSetting('wait', this.checked)">
              <label for="tool-wait">
                Wait
                <div class="tool-description">Allow AI to pause thinking for 10 seconds</div>
              </label>
            </div>
          </div>
        </div>
        <input type="text" id="promptInput" class="chat-input" placeholder="Type your message..." />
        <button id="sendBtn" class="send-button" onclick="sendPrompt()">Send</button>
      </div>
    </div>
  </div>

  <script>
    let chatWS = null;
    let debugWS = null;
    let isAwake = false;
    let currentThinkingIndicator = null;
    let currentAIMessage = null;
    let debugLogEntries = [];
    let currentThoughtEntry = null;
    let toolSettings = {
      send_message_to_user: true,
      wait: true
    };

    function toggleDebugSidebar() {
      const sidebar = document.getElementById('debugSidebar');
      const chatContainer = document.getElementById('chatContainer');
      sidebar.classList.toggle('open');
      chatContainer.classList.toggle('sidebar-open');
    }

    function toggleToolsDropdown() {
      const dropdown = document.getElementById('toolsDropdown');
      dropdown.classList.toggle('open');
    }

    function updateToolSetting(toolName, enabled) {
      toolSettings[toolName] = enabled;

      // Send tool configuration to backend
      if (chatWS && chatWS.readyState === WebSocket.OPEN) {
        chatWS.send(JSON.stringify({
          type: 'tool_config',
          tools: toolSettings
        }));
        addDebugLogEntry('system', `Tool configuration updated: ${toolName} = ${enabled}`);
      }
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      const dropdown = document.getElementById('toolsDropdown');
      const gearIcon = document.querySelector('.gear-icon');
      if (dropdown && gearIcon && !dropdown.contains(e.target) && !gearIcon.contains(e.target)) {
        dropdown.classList.remove('open');
      }
    });

    function addDebugLogEntry(type, content, metadata = {}) {
      const debugLog = document.getElementById('debugLog');

      // For thought chunks, accumulate in the same entry
      if (type === 'ai-thinking' && metadata.chunk && currentThoughtEntry) {
        const contentDiv = currentThoughtEntry.querySelector('.debug-entry-content');
        const currentContent = contentDiv.textContent;
        contentDiv.textContent = currentContent + content;
        debugLog.scrollTop = debugLog.scrollHeight;
        return;
      }

      // Create new entry
      const entry = document.createElement('div');
      entry.className = `debug-entry ${type}`;

      const timestamp = new Date().toLocaleTimeString();
      const header = document.createElement('div');
      header.className = 'debug-entry-header';

      const typeLabel = document.createElement('span');
      typeLabel.textContent = type.replace(/-/g, ' ').toUpperCase();

      const timeLabel = document.createElement('span');
      timeLabel.className = 'debug-entry-time';
      timeLabel.textContent = timestamp;

      header.appendChild(typeLabel);
      header.appendChild(timeLabel);

      const contentDiv = document.createElement('div');
      contentDiv.className = 'debug-entry-content';

      if (typeof content === 'object') {
        contentDiv.textContent = JSON.stringify(content, null, 2);
      } else {
        contentDiv.textContent = content;
      }

      entry.appendChild(header);
      entry.appendChild(contentDiv);

      debugLog.appendChild(entry);
      debugLog.scrollTop = debugLog.scrollHeight;

      // Store entry reference for thought chunks
      if (type === 'ai-thinking' && !metadata.chunk) {
        currentThoughtEntry = entry;
      } else {
        currentThoughtEntry = null;
      }

      // Store entry for persistence
      debugLogEntries.push({
        type,
        content: typeof content === 'object' ? JSON.stringify(content, null, 2) : content,
        timestamp,
        metadata
      });
    }

    function formatMessageText(text) {
      // Escape HTML to prevent XSS attacks
      const div = document.createElement('div');
      div.textContent = text;
      let escaped = div.innerHTML;

      // Convert escape sequences to HTML
      // Handle \n as line breaks
      escaped = escaped.replace(/\\n/g, '<br>');
      // Handle actual newlines (in case they're already in the text)
      escaped = escaped.replace(/\n/g, '<br>');
      // Handle \t as 4 spaces
      escaped = escaped.replace(/\\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;');
      // Handle actual tabs
      escaped = escaped.replace(/\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;');

      return escaped;
    }

    function addMessage(text, isUser, timestamp = null) {
      const messagesContainer = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;

      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';
      bubble.innerHTML = formatMessageText(text);

      const timeDiv = document.createElement('div');
      timeDiv.className = 'message-time';
      timeDiv.textContent = timestamp || new Date().toLocaleTimeString();

      messageDiv.appendChild(bubble);
      messageDiv.appendChild(timeDiv);
      messagesContainer.appendChild(messageDiv);

      // Scroll to bottom
      messagesContainer.scrollTop = messagesContainer.scrollHeight;

      return messageDiv;
    }

    function showThinkingIndicator() {
      const messagesContainer = document.getElementById('chatMessages');

      // Remove existing thinking indicator if any
      if (currentThinkingIndicator) {
        currentThinkingIndicator.remove();
      }

      const thinkingDiv = document.createElement('div');
      thinkingDiv.className = 'thinking-indicator';
      thinkingDiv.id = 'thinkingIndicator';
      thinkingDiv.innerHTML = `
        <span>AI is thinking</span>
        <div class="thinking-dots">
          <span></span>
          <span></span>
          <span></span>
        </div>
      `;

      messagesContainer.appendChild(thinkingDiv);
      currentThinkingIndicator = thinkingDiv;
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function hideThinkingIndicator() {
      if (currentThinkingIndicator) {
        currentThinkingIndicator.remove();
        currentThinkingIndicator = null;
      }
    }

    function updateAIMessage(text, timestamp = null) {
      if (!currentAIMessage) {
        currentAIMessage = addMessage(text, false, timestamp);
      } else {
        const bubble = currentAIMessage.querySelector('.message-bubble');
        bubble.innerHTML = formatMessageText(text);
        if (timestamp) {
          const timeDiv = currentAIMessage.querySelector('.message-time');
          timeDiv.textContent = timestamp;
        }
        // Scroll to bottom
        document.getElementById('chatMessages').scrollTop =
          document.getElementById('chatMessages').scrollHeight;
      }
    }

    function showError(message) {
      const messagesContainer = document.getElementById('chatMessages');
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.textContent = `Error: ${message}`;
      messagesContainer.appendChild(errorDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function updateStatus(connected, text) {
      const statusDot = document.getElementById('statusDot');
      const statusText = document.getElementById('statusText');
      if (connected) {
        statusDot.className = 'status-dot connected';
        statusText.textContent = text || 'Connected';
      } else {
        statusDot.className = 'status-dot disconnected';
        statusText.textContent = text || 'Disconnected';
      }
    }

    function connectWebSockets() {
      // Connect to chat WebSocket
      chatWS = new WebSocket('ws://localhost:8000/ws/chat');

      chatWS.onopen = () => {
        updateStatus(true, 'Chat connected');
      };

      chatWS.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.type === 'status') {
          // Update status text based on message
          if (data.message.includes('waking up')) {
            updateStatus(true, 'Starting...');
          } else if (data.message.includes('sleep')) {
            updateStatus(true, 'Paused');
          } else {
            updateStatus(true, 'Connected');
          }
        } else if (data.type === 'ai_message') {
          // Message from AI via tool call - only actual messages go to chat
          hideThinkingIndicator();
          const timestamp = data.timestamp ? new Date(data.timestamp).toLocaleTimeString() : null;
          addMessage(data.content, false, timestamp);
          currentAIMessage = null;
        } else if (data.type === 'error') {
          updateStatus(false, 'Error');
          hideThinkingIndicator();
          showError(data.message);
        }
      };

      chatWS.onerror = () => {
        updateStatus(false, 'Chat error');
      };

      chatWS.onclose = () => {
        updateStatus(false, 'Disconnected');
        setTimeout(connectWebSockets, 3000);
      };

      // Connect to debug WebSocket
      debugWS = new WebSocket('ws://localhost:8000/ws/debug');

      debugWS.onopen = () => {
        // Update status if chat is also connected
        if (chatWS && chatWS.readyState === WebSocket.OPEN) {
          updateStatus(true, 'Connected');
        }
        addDebugLogEntry('system', 'Debug WebSocket connected');
      };

      debugWS.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.type === 'status') {
          addDebugLogEntry('system', `Status: ${data.message}`, { timestamp: data.timestamp });
        } else if (data.type === 'invocation') {
          const promptText = data.prompt ? `\n\nPrompt:\n${data.prompt}` : '';
          addDebugLogEntry('system', `LLM invocation started${promptText}`, { timestamp: data.timestamp });
        } else if (data.type === 'thought_start') {
          currentThoughtEntry = null; // Reset thought entry
          addDebugLogEntry('ai-thinking', '', { timestamp: data.timestamp });
        } else if (data.type === 'thought_chunk') {
          addDebugLogEntry('ai-thinking', data.content, { timestamp: data.timestamp, chunk: true });
        } else if (data.type === 'tool_call') {
          currentThoughtEntry = null; // Reset thought entry after tool call
          addDebugLogEntry('tool-call', {
            tool: data.tool,
            message: data.message
          }, { timestamp: data.timestamp });
        } else if (data.type === 'error') {
          addDebugLogEntry('error', data.message, { timestamp: data.timestamp });
        }
      };

      debugWS.onerror = () => {
        // Status will be updated based on chat connection
      };

      debugWS.onclose = () => {
        setTimeout(connectWebSockets, 3000);
      };
    }

    function sendPrompt() {
      const prompt = document.getElementById('promptInput').value.trim();
      if (!prompt) return;

      if (!chatWS || chatWS.readyState !== WebSocket.OPEN) {
        alert('Chat WebSocket is not connected. Please wait for connection.');
        return;
      }

      // Add user message to chat
      addMessage(prompt, true);

      // Log to debug
      addDebugLogEntry('user-message', prompt);

      // Send user message to backend via chat socket
      chatWS.send(JSON.stringify({
        type: 'user_message',
        content: prompt,
        timestamp: new Date().toISOString()
      }));

      // Clear input
      document.getElementById('promptInput').value = '';
    }

    function togglePlayPause() {
      if (!chatWS || chatWS.readyState !== WebSocket.OPEN) {
        alert('Chat WebSocket is not connected. Please wait for connection.');
        return;
      }

      const btn = document.getElementById('playPauseBtn');

      if (!isAwake) {
        // Play - wake up the AI
        isAwake = true;
        btn.textContent = '‚è∏ Pause';
        btn.classList.remove('paused');
        btn.classList.add('active');
        chatWS.send(JSON.stringify({ type: 'wake_up' }));
        addDebugLogEntry('system', 'AI play command sent');
      } else {
        // Pause - put AI to sleep
        isAwake = false;
        btn.textContent = '‚ñ∂ Play';
        btn.classList.remove('active');
        btn.classList.add('paused');
        chatWS.send(JSON.stringify({ type: 'sleep' }));
        addDebugLogEntry('system', 'AI pause command sent');
      }
    }

    // Allow Enter key to send
    document.getElementById('promptInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendPrompt();
      }
    });

    // Connect on page load
    connectWebSockets();
  </script>
</body>

</html>

</html>