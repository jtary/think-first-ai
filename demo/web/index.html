<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Think First AI - Demo</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --header-height: 60px;
      --sidebar-width: 400px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .header {
      background: white;
      padding: 15px 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      z-index: 10;
      height: var(--header-height);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }

    h1 {
      color: #667eea;
      font-size: 1.5em;
      margin: 0;
    }

    .header-controls {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }

    .status-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .status-item {
      padding: 8px 12px;
      border-radius: 5px;
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
    }

    .status-item.connected {
      background: #4caf50;
      color: white;
    }

    .status-item.disconnected {
      background: #f44336;
      color: white;
    }

    button {
      padding: 8px 16px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: background 0.3s;
    }

    button:hover {
      background: #5568d3;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    button.active {
      background: #4caf50;
    }

    button.active:hover {
      background: #45a049;
    }

    .main-content {
      flex: 1;
      display: flex;
      overflow: hidden;
      position: relative;
    }

    .chat-container {
      flex: 1;
      max-width: 1200px;
      width: 100%;
      margin: 20px auto;
      padding: 0 20px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: margin-right 0.3s ease;
    }

    .chat-container.sidebar-open {
      margin-right: 400px;
    }

    .chat-messages {
      flex: 1;
      background: white;
      border-radius: 10px;
      padding: 20px;
      overflow-y: auto;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      gap: 15px;
      min-height: 0;
    }

    .message {
      display: flex;
      max-width: 70%;
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.user {
      align-self: flex-end;
      justify-content: flex-end;
    }

    .message.ai {
      align-self: flex-start;
      justify-content: flex-start;
    }

    .message-bubble {
      padding: 12px 16px;
      border-radius: 18px;
      word-wrap: break-word;
      white-space: pre-wrap;
      line-height: 1.4;
    }

    .message.user .message-bubble {
      background: #667eea;
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message.ai .message-bubble {
      background: #f0f0f0;
      color: #333;
      border-bottom-left-radius: 4px;
    }

    .message-time {
      font-size: 11px;
      color: #999;
      margin-top: 4px;
      padding: 0 4px;
    }

    .message.user .message-time {
      text-align: right;
    }

    .message.ai .message-time {
      text-align: left;
    }

    .thinking-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background: #fff3cd;
      border-radius: 18px;
      border-bottom-left-radius: 4px;
      color: #856404;
      font-size: 14px;
      max-width: 70%;
      align-self: flex-start;
    }

    .thinking-dots {
      display: inline-flex;
      gap: 4px;
    }

    .thinking-dots span {
      width: 6px;
      height: 6px;
      background: #856404;
      border-radius: 50%;
      animation: thinking 1.4s infinite;
    }

    .thinking-dots span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .thinking-dots span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes thinking {

      0%,
      60%,
      100% {
        opacity: 0.3;
        transform: scale(0.8);
      }

      30% {
        opacity: 1;
        transform: scale(1);
      }
    }

    .chat-footer {
      background: white;
      padding: 15px 20px;
      border-radius: 10px;
      margin-top: 15px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      display: flex;
      gap: 10px;
    }

    .chat-input {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 25px;
      font-size: 16px;
      font-family: inherit;
      outline: none;
      transition: border-color 0.3s;
    }

    .chat-input:focus {
      border-color: #667eea;
    }

    .send-button {
      padding: 12px 24px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: background 0.3s;
      min-width: 80px;
    }

    .send-button:hover {
      background: #5568d3;
    }

    .send-button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .error-message {
      background: #ffebee;
      color: #c62828;
      padding: 12px 16px;
      border-radius: 18px;
      border-bottom-left-radius: 4px;
      max-width: 70%;
      align-self: flex-start;
    }

    .sidebar {
      position: fixed;
      right: calc(var(--sidebar-width) * -1);
      top: var(--header-height);
      width: var(--sidebar-width);
      height: calc(100vh - var(--header-height));
      background: white;
      box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
      transition: right 0.3s ease;
      z-index: 100;
      display: flex;
      flex-direction: column;
    }

    .sidebar.open {
      right: 0;
    }

    .sidebar-header {
      padding: 15px 20px;
      border-bottom: 2px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f5f5f5;
    }

    .sidebar-header h2 {
      color: #333;
      font-size: 1.2em;
      margin: 0;
    }

    .sidebar-close {
      background: transparent;
      color: #666;
      padding: 4px 8px;
      font-size: 20px;
      border: none;
      cursor: pointer;
      line-height: 1;
    }

    .sidebar-close:hover {
      color: #333;
      background: #e0e0e0;
    }

    .debug-log {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.6;
      background: #1e1e1e;
      color: #d4d4d4;
    }

    .debug-entry {
      margin-bottom: 12px;
      padding: 8px 12px;
      border-radius: 4px;
      border-left: 3px solid;
      background: rgba(255, 255, 255, 0.05);
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    .debug-entry.user-message {
      border-left-color: #667eea;
      background: rgba(102, 126, 234, 0.1);
    }

    .debug-entry.ai-thinking {
      border-left-color: #ffc107;
      background: rgba(255, 193, 7, 0.1);
    }

    .debug-entry.tool-call {
      border-left-color: #4caf50;
      background: rgba(76, 175, 80, 0.1);
    }

    .debug-entry.ai-message {
      border-left-color: #2196f3;
      background: rgba(33, 150, 243, 0.1);
    }

    .debug-entry.error {
      border-left-color: #f44336;
      background: rgba(244, 67, 54, 0.1);
    }

    .debug-entry.system {
      border-left-color: #9e9e9e;
      background: rgba(158, 158, 158, 0.1);
    }

    .debug-entry-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      opacity: 0.8;
    }

    .debug-entry-time {
      font-size: 10px;
      opacity: 0.6;
    }

    .debug-entry-content {
      margin-top: 4px;
    }

    .debug-toggle-btn {
      background: #9e9e9e;
    }

    .debug-toggle-btn:hover {
      background: #757575;
    }

    @media (max-width: 768px) {
      .message {
        max-width: 85%;
      }

      .header-content {
        flex-direction: column;
        align-items: flex-start;
      }

      .status-group {
        width: 100%;
      }

      .status-item {
        flex: 1;
        text-align: center;
      }

      .sidebar {
        width: 100%;
        right: -100%;
      }

      .sidebar.open {
        right: 0;
      }

      .chat-container.sidebar-open {
        margin-right: 0;
      }
    }
  </style>
</head>

<body>
  <div class="header">
    <div class="header-content">
      <h1>ðŸ§  Think First AI</h1>
      <div class="header-controls">
        <div class="status-group">
          <div id="thoughtsStatus" class="status-item disconnected">Thoughts: Disconnected</div>
          <div id="outputsStatus" class="status-item disconnected">Outputs: Disconnected</div>
          <div id="wakeUpStatus" class="status-item disconnected">AI: Sleeping</div>
        </div>
        <button id="wakeUpBtn" onclick="toggleWakeUp()">Wake Up</button>
        <button id="debugToggleBtn" class="debug-toggle-btn" onclick="toggleDebugSidebar()">Debug</button>
      </div>
    </div>
  </div>

  <div class="sidebar" id="debugSidebar">
    <div class="debug-log" id="debugLog"></div>
  </div>

  <div class="main-content">
    <div class="chat-container" id="chatContainer">
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-footer">
        <input type="text" id="promptInput" class="chat-input" placeholder="Type your message..." />
        <button id="sendBtn" class="send-button" onclick="sendPrompt()">Send</button>
      </div>
    </div>
  </div>

  <script>
    let thoughtsWS = null;
    let outputsWS = null;
    let wakeUpWS = null;
    let isAwake = false;
    let currentThinkingIndicator = null;
    let currentAIMessage = null;
    let debugLogEntries = [];
    let currentThoughtEntry = null;

    function toggleDebugSidebar() {
      const sidebar = document.getElementById('debugSidebar');
      const chatContainer = document.getElementById('chatContainer');
      sidebar.classList.toggle('open');
      chatContainer.classList.toggle('sidebar-open');
    }

    function addDebugLogEntry(type, content, metadata = {}) {
      const debugLog = document.getElementById('debugLog');

      // For thought chunks, accumulate in the same entry
      if (type === 'ai-thinking' && metadata.chunk && currentThoughtEntry) {
        const contentDiv = currentThoughtEntry.querySelector('.debug-entry-content');
        const currentContent = contentDiv.textContent;
        contentDiv.textContent = currentContent + content;
        debugLog.scrollTop = debugLog.scrollHeight;
        return;
      }

      // Create new entry
      const entry = document.createElement('div');
      entry.className = `debug-entry ${type}`;

      const timestamp = new Date().toLocaleTimeString();
      const header = document.createElement('div');
      header.className = 'debug-entry-header';

      const typeLabel = document.createElement('span');
      typeLabel.textContent = type.replace(/-/g, ' ').toUpperCase();

      const timeLabel = document.createElement('span');
      timeLabel.className = 'debug-entry-time';
      timeLabel.textContent = timestamp;

      header.appendChild(typeLabel);
      header.appendChild(timeLabel);

      const contentDiv = document.createElement('div');
      contentDiv.className = 'debug-entry-content';

      if (typeof content === 'object') {
        contentDiv.textContent = JSON.stringify(content, null, 2);
      } else {
        contentDiv.textContent = content;
      }

      entry.appendChild(header);
      entry.appendChild(contentDiv);

      debugLog.appendChild(entry);
      debugLog.scrollTop = debugLog.scrollHeight;

      // Store entry reference for thought chunks
      if (type === 'ai-thinking' && !metadata.chunk) {
        currentThoughtEntry = entry;
      } else {
        currentThoughtEntry = null;
      }

      // Store entry for persistence
      debugLogEntries.push({
        type,
        content: typeof content === 'object' ? JSON.stringify(content, null, 2) : content,
        timestamp,
        metadata
      });
    }

    function addMessage(text, isUser, timestamp = null) {
      const messagesContainer = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;

      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';
      bubble.textContent = text;

      const timeDiv = document.createElement('div');
      timeDiv.className = 'message-time';
      timeDiv.textContent = timestamp || new Date().toLocaleTimeString();

      messageDiv.appendChild(bubble);
      messageDiv.appendChild(timeDiv);
      messagesContainer.appendChild(messageDiv);

      // Scroll to bottom
      messagesContainer.scrollTop = messagesContainer.scrollHeight;

      return messageDiv;
    }

    function showThinkingIndicator() {
      const messagesContainer = document.getElementById('chatMessages');

      // Remove existing thinking indicator if any
      if (currentThinkingIndicator) {
        currentThinkingIndicator.remove();
      }

      const thinkingDiv = document.createElement('div');
      thinkingDiv.className = 'thinking-indicator';
      thinkingDiv.id = 'thinkingIndicator';
      thinkingDiv.innerHTML = `
        <span>AI is thinking</span>
        <div class="thinking-dots">
          <span></span>
          <span></span>
          <span></span>
        </div>
      `;

      messagesContainer.appendChild(thinkingDiv);
      currentThinkingIndicator = thinkingDiv;
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function hideThinkingIndicator() {
      if (currentThinkingIndicator) {
        currentThinkingIndicator.remove();
        currentThinkingIndicator = null;
      }
    }

    function updateAIMessage(text, timestamp = null) {
      if (!currentAIMessage) {
        currentAIMessage = addMessage(text, false, timestamp);
      } else {
        const bubble = currentAIMessage.querySelector('.message-bubble');
        bubble.textContent = text;
        if (timestamp) {
          const timeDiv = currentAIMessage.querySelector('.message-time');
          timeDiv.textContent = timestamp;
        }
        // Scroll to bottom
        document.getElementById('chatMessages').scrollTop =
          document.getElementById('chatMessages').scrollHeight;
      }
    }

    function showError(message) {
      const messagesContainer = document.getElementById('chatMessages');
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.textContent = `Error: ${message}`;
      messagesContainer.appendChild(errorDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function connectWebSockets() {
      // Connect to thoughts WebSocket
      thoughtsWS = new WebSocket('ws://localhost:8000/ws/thoughts');

      thoughtsWS.onopen = () => {
        document.getElementById('thoughtsStatus').textContent = 'Thoughts: Connected';
        document.getElementById('thoughtsStatus').className = 'status-item connected';
        addDebugLogEntry('system', 'Thoughts WebSocket connected');
      };

      thoughtsWS.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === 'thought') {
          // Thoughts are now shown via wakeup WebSocket
          addDebugLogEntry('ai-thinking', data.content, { done: data.done });
        } else if (data.type === 'error') {
          showError(data.message);
          addDebugLogEntry('error', data.message);
        }
      };

      thoughtsWS.onerror = () => {
        document.getElementById('thoughtsStatus').textContent = 'Thoughts: Error';
        document.getElementById('thoughtsStatus').className = 'status-item disconnected';
      };

      thoughtsWS.onclose = () => {
        document.getElementById('thoughtsStatus').textContent = 'Thoughts: Disconnected';
        document.getElementById('thoughtsStatus').className = 'status-item disconnected';
        setTimeout(connectWebSockets, 3000);
      };

      // Connect to outputs WebSocket
      outputsWS = new WebSocket('ws://localhost:8000/ws/outputs');

      outputsWS.onopen = () => {
        document.getElementById('outputsStatus').textContent = 'Outputs: Connected';
        document.getElementById('outputsStatus').className = 'status-item connected';
        addDebugLogEntry('system', 'Outputs WebSocket connected');
      };

      outputsWS.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === 'user_message') {
          // Message from AI via tool call
          hideThinkingIndicator();
          const timestamp = data.timestamp ? new Date(data.timestamp).toLocaleTimeString() : null;
          addMessage(data.content, false, timestamp);
          addDebugLogEntry('ai-message', data.content, { timestamp: data.timestamp });
          currentAIMessage = null;
        } else if (data.type === 'error') {
          hideThinkingIndicator();
          showError(data.message);
          addDebugLogEntry('error', data.message);
        }
      };

      outputsWS.onerror = () => {
        document.getElementById('outputsStatus').textContent = 'Outputs: Error';
        document.getElementById('outputsStatus').className = 'status-item disconnected';
      };

      outputsWS.onclose = () => {
        document.getElementById('outputsStatus').textContent = 'Outputs: Disconnected';
        document.getElementById('outputsStatus').className = 'status-item disconnected';
        setTimeout(connectWebSockets, 3000);
      };

      // Connect to wake up WebSocket
      wakeUpWS = new WebSocket('ws://localhost:8000/ws/wakeup');

      wakeUpWS.onopen = () => {
        document.getElementById('wakeUpStatus').textContent = 'AI: Connected';
        document.getElementById('wakeUpStatus').className = 'status-item connected';
        addDebugLogEntry('system', 'Wake Up WebSocket connected');
      };

      wakeUpWS.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.type === 'status') {
          const statusEl = document.getElementById('wakeUpStatus');
          statusEl.textContent = `AI: ${data.message}`;
          statusEl.className = 'status-item connected';
          addDebugLogEntry('system', `Status: ${data.message}`, { timestamp: data.timestamp });
        } else if (data.type === 'invocation') {
          const statusEl = document.getElementById('wakeUpStatus');
          statusEl.textContent = `AI: Thinking (${new Date(data.timestamp).toLocaleTimeString()})`;
          statusEl.className = 'status-item connected';
          showThinkingIndicator();
          addDebugLogEntry('system', 'LLM invocation started', { timestamp: data.timestamp });
        } else if (data.type === 'thought_start') {
          // New thought starting
          currentAIMessage = null;
          hideThinkingIndicator();
          currentThoughtEntry = null; // Reset thought entry
          addDebugLogEntry('ai-thinking', '', { timestamp: data.timestamp });
        } else if (data.type === 'thought_chunk') {
          // Stream thought chunks - show as thinking process
          hideThinkingIndicator();
          const timestamp = data.timestamp ? new Date(data.timestamp).toLocaleTimeString() : null;
          updateAIMessage(data.content, timestamp);
          addDebugLogEntry('ai-thinking', data.content, { timestamp: data.timestamp, chunk: true });
        } else if (data.type === 'tool_call') {
          const statusEl = document.getElementById('wakeUpStatus');
          statusEl.textContent = `AI: Sent message (${new Date(data.timestamp).toLocaleTimeString()})`;
          statusEl.className = 'status-item connected';
          hideThinkingIndicator();
          currentThoughtEntry = null; // Reset thought entry after tool call
          addDebugLogEntry('tool-call', {
            tool: data.tool,
            message: data.message
          }, { timestamp: data.timestamp });
        } else if (data.type === 'error') {
          document.getElementById('wakeUpStatus').textContent = 'AI: Error';
          document.getElementById('wakeUpStatus').className = 'status-item disconnected';
          hideThinkingIndicator();
          showError(data.message);
          addDebugLogEntry('error', data.message, { timestamp: data.timestamp });
        }
      };

      wakeUpWS.onerror = () => {
        document.getElementById('wakeUpStatus').textContent = 'AI: Error';
        document.getElementById('wakeUpStatus').className = 'status-item disconnected';
      };

      wakeUpWS.onclose = () => {
        document.getElementById('wakeUpStatus').textContent = 'AI: Disconnected';
        document.getElementById('wakeUpStatus').className = 'status-item disconnected';
        setTimeout(connectWebSockets, 3000);
      };
    }

    function sendPrompt() {
      const prompt = document.getElementById('promptInput').value.trim();
      if (!prompt) return;

      // Add user message to chat
      addMessage(prompt, true);

      // Log to debug
      addDebugLogEntry('user-message', prompt);

      // Send to WebSockets if needed (for legacy support)
      if (thoughtsWS && thoughtsWS.readyState === WebSocket.OPEN) {
        thoughtsWS.send(JSON.stringify({ type: 'generate', prompt }));
      }

      if (outputsWS && outputsWS.readyState === WebSocket.OPEN) {
        outputsWS.send(JSON.stringify({ type: 'generate', prompt }));
      }

      // Clear input
      document.getElementById('promptInput').value = '';
    }

    function toggleWakeUp() {
      if (!wakeUpWS || wakeUpWS.readyState !== WebSocket.OPEN) {
        alert('Wake up WebSocket is not connected. Please wait for connection.');
        return;
      }

      const btn = document.getElementById('wakeUpBtn');

      if (!isAwake) {
        isAwake = true;
        btn.textContent = 'Sleep';
        btn.classList.add('active');
        wakeUpWS.send(JSON.stringify({ type: 'wake_up' }));
        addDebugLogEntry('system', 'AI wake up command sent');
      } else {
        isAwake = false;
        btn.textContent = 'Wake Up';
        btn.classList.remove('active');
        wakeUpWS.send(JSON.stringify({ type: 'sleep' }));
        addDebugLogEntry('system', 'AI sleep command sent');
      }
    }

    // Allow Enter key to send
    document.getElementById('promptInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendPrompt();
      }
    });

    // Connect on page load
    connectWebSockets();
  </script>
</body>

</html>

</html>